<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Cloud Bookmarks</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Drag and Drop script -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        :root { 
            --primary: #2563eb; 
            --bg: #f8fafc; 
            --white: #ffffff; 
            --text: #1e293b; 
            --radius: 12px; 
            --card-size: 140px; 
            --icon-size: 2.5em; 
            --title-size: 0.9em; 
            --list-cols: 1; 
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body { font-family: var(--font-family); background: var(--bg); color: var(--text); margin: 0; padding: 0; transition: background 0.3s, color 0.3s; }
        
        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        
        /* --- LOADER --- */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; transition: background 0.3s; }
        .spinner { border: 4px solid #cbd5e1; border-top: 4px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loader-text { font-weight: bold; color: var(--primary); }

        /* --- AUTH SCREEN --- */
        #auth-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; display: none; }
        .auth-card { background: var(--white); padding: 30px; border-radius: var(--radius); box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; transition: background 0.3s; }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; transition: color 0.3s;}
        
        /* Remove spinners for number inputs */
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        .input-group input, .control-group select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; font-size: 1em; transition: background 0.3s, color 0.3s, border-color 0.3s; }
        .input-group input:disabled { background-color: #f1f5f9; cursor: not-allowed; color: #64748b; }
        
        .btn-full { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.2s; font-size: 1em; font-family: inherit; }
        .btn-full:active { transform: scale(0.98); }
        .btn-full:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: #64748b; margin-top: 5px; }
        .toggle-link { margin-top: 15px; cursor: pointer; color: var(--primary); text-decoration: underline; display: block; font-size: 0.9em; }
        
        /* Support Box for PIN Reset */
        .support-box { margin-top: 20px; padding: 15px; background: #eff6ff; border: 1px dashed var(--primary); border-radius: 8px; font-size: 0.9em; color: #1e40af; text-align: center; transition: background 0.3s, color 0.3s; }
        .support-btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; background: #25D366; color: white; padding: 10px 20px; border-radius: 30px; text-decoration: none; font-weight: bold; margin-top: 10px; transition: 0.3s; }
        .support-btn:hover { background: #128c7e; transform: scale(1.05); }

        /* --- APP UI LAYOUT --- */
        #app-container { max-width: 1200px; margin: 0 auto; padding: 12px; display: grid; grid-template-columns: 1fr; gap: 15px; display: none; transition: 0.3s; }
        #app-container.with-sidebar { grid-template-columns: 320px 1fr; }
        @media (max-width: 768px) { #app-container.with-sidebar { grid-template-columns: 1fr; } }
        
        .sidebar { background: var(--white); padding: 15px; border-radius: var(--radius); box-shadow: 0 2px 10px rgba(0,0,0,0.05); height: fit-content; display: none; transition: background 0.3s; }
        #app-container.with-sidebar .sidebar { display: block; }
        .main-area { background: #e2e8f0; padding: 15px; border-radius: var(--radius); min-height: 80vh; transition: background 0.3s; }
        
        .user-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; background: var(--white); padding: 10px 15px; border-radius: var(--radius); box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: background 0.3s; }
        .logout-btn { background: #ef4444; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; font-family: inherit;}

        /* --- BOOKMARK CARDS AND FILTERS --- */
        .section-title { width: 100%; border-bottom: 2px solid var(--primary); margin: 15px 0 10px 0; font-weight: bold; color: var(--text); font-size: 1.1em; padding-bottom: 5px; text-transform: capitalize; transition: color 0.3s; }
        .bookmarks-container { display: flex; gap: 12px; margin-bottom: 20px; }
        
        /* Main Category Filter Styles */
        .category-filter { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 5px; scrollbar-width: none; -ms-overflow-style: none; }
        .category-filter::-webkit-scrollbar { display: none; }
        .filter-btn { padding: 6px 14px; border-radius: 20px; border: 1px solid #cbd5e1; background: var(--white); cursor: pointer; white-space: nowrap; transition: 0.2s; font-weight: 600; color: var(--text); font-size: 0.9em; font-family: inherit;}
        .filter-btn:hover { border-color: var(--primary); color: var(--primary); }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Sub-Category Filter Styles */
        .subcategory-filter { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 8px; margin-bottom: 15px; scrollbar-width: none; border-bottom: 1px dashed #cbd5e1; align-items: center; transition: border-color 0.3s; }
        .subcategory-filter::before { content: "Sub-Categories:"; font-size: 0.8em; font-weight: bold; color: #64748b; padding-right: 5px; }
        .subcategory-filter::-webkit-scrollbar { display: none; }
        .sub-filter-btn { padding: 4px 12px; border-radius: 15px; border: 1px solid #e2e8f0; background: #f1f5f9; cursor: pointer; font-size: 0.85em; transition: 0.2s; color: #475569; white-space: nowrap; font-weight: 600; font-family: inherit;}
        .sub-filter-btn:hover { border-color: var(--primary); color: var(--primary); background: #e0f2fe; }
        .sub-filter-btn.active { background: #bae6fd; color: #0369a1; border-color: #38bdf8; }

        /* GRID VIEW (Horizontal) */
        .view-grid { flex-wrap: wrap; }
        .view-grid .b-card { 
            background: var(--white); width: var(--card-size); height: var(--card-size); border-radius: 12px; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; text-decoration: none; color: var(--text); 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; cursor: pointer; transition: 0.2s;
        }
        .view-grid .b-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .view-grid .b-icon { font-size: var(--icon-size); margin-bottom: 8px; color: var(--primary); transition: 0.2s; }
        .view-grid .b-title { font-weight: 600; font-size: var(--title-size); text-align: center; word-break: break-word; padding: 0 5px; transition: 0.2s; }
        .view-grid .action-btns { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; opacity: 0; visibility: hidden; transition: 0.2s; }
        .view-grid .b-card:hover .action-btns { opacity: 1; visibility: visible; }

        /* LIST VIEW (Vertical/Grid Hybrid) */
        .view-list { display: grid; grid-template-columns: repeat(var(--list-cols), 1fr); gap: 12px; width: 100%; }
        @media (max-width: 768px) { .view-list { grid-template-columns: 1fr; } }
        .view-list .b-card {
            background: var(--white); width: 100%; padding: 10px 15px; border-radius: 8px; display: flex; 
            align-items: center; justify-content: space-between; text-decoration: none; color: var(--text);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: relative; cursor: pointer; box-sizing: border-box; transition: background 0.3s, color 0.3s;
        }
        .view-list .card-content { display: flex; align-items: center; gap: 15px; }
        .view-list .b-icon { font-size: 1.5em; color: var(--primary); width: 30px; text-align: center; }
        .view-list .action-btns { display: flex; gap: 10px; opacity: 0; visibility: hidden; transition: 0.2s; }
        .view-list .b-card:hover .action-btns { opacity: 1; visibility: visible; }

        /* MOBILE TOUCH FALLBACK */
        @media (hover: none) {
            .view-grid .action-btns, .view-list .action-btns { opacity: 0.7; visibility: visible; }
        }

        /* ACTIONS & ICONS */
        .action-btn { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9em; border: none; cursor: pointer; transition: 0.2s; }
        .btn-edit { background: #f59e0b; color: white; }
        .btn-edit:hover { background: #d97706; }
        .btn-del { background: #ef4444; color: white; }
        .btn-del:hover { background: #dc2626; }
        
        .icon-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; max-height: 120px; overflow-y: auto; margin-bottom: 10px; border: 1px solid #eee; padding: 5px; border-radius: 6px; transition: border-color 0.3s; }
        .icon-option { text-align: center; padding: 8px; cursor: pointer; border-radius: 4px; transition: 0.2s; }
        .icon-option:hover { background: #f1f5f9; }
        .icon-option.selected { background: var(--primary); color: white; }
        
        .control-group { margin-bottom: 15px; }
        .control-group select, .control-group input[type="color"] { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #cbd5e1; font-family: inherit;}
        
        /* Drag and Drop Styling */
        .sortable-ghost { opacity: 0.4; background: #e2e8f0; border: 2px dashed var(--primary); }
        .cursor-grab { cursor: grab; }
        .cursor-grab:active { cursor: grabbing; }

        /* --- TOGGLE SWITCH CSS --- */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* --- THEME DROPDOWN BUTTONS --- */
        .theme-btn { padding: 10px; text-align: left; background: transparent; border: none; cursor: pointer; border-radius: 4px; font-size: 0.9em; transition: 0.2s; color: var(--text); display: flex; align-items: center; width: 100%; }
        .theme-btn:hover { background: #f1f5f9; }

        /* Theme Dropdown Scrollbar */
        #theme-dropdown::-webkit-scrollbar { width: 6px; }
        #theme-dropdown::-webkit-scrollbar-track { background: transparent; }
        #theme-dropdown::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        #theme-dropdown::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* --- DARK MODE OVERRIDES --- */
        body.dark-mode { --bg: #0f172a; --white: #1e293b; --text: #f1f5f9; }
        body.dark-mode .main-area { background: #020617; }
        body.dark-mode .input-group input, body.dark-mode .control-group select { background: #334155; color: #f1f5f9; border-color: #475569; }
        body.dark-mode .input-group input:disabled { background: #1e293b; color: #94a3b8; border-color: #334155; }
        body.dark-mode .category-filter .filter-btn { background: #334155; color: #cbd5e1; border-color: #475569; }
        body.dark-mode .category-filter .filter-btn:hover { border-color: var(--primary); color: var(--primary); }
        body.dark-mode .category-filter .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        body.dark-mode .subcategory-filter { border-bottom-color: #334155; }
        body.dark-mode .subcategory-filter::before { color: #94a3b8; }
        body.dark-mode .subcategory-filter .sub-filter-btn { background: #0f172a; color: #94a3b8; border-color: #334155; }
        body.dark-mode .subcategory-filter .sub-filter-btn:hover { border-color: var(--primary); color: var(--primary); background: #1e293b; }
        body.dark-mode .subcategory-filter .sub-filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        body.dark-mode .icon-option:hover { background: #334155; }
        body.dark-mode .icon-grid { border-color: #334155; }
        body.dark-mode hr { border-top-color: #334155 !important; }
        body.dark-mode .support-box { background: #0f172a; border-color: var(--primary); color: #cbd5e1; }
        body.dark-mode #reset-step-2 { border-top-color: #475569 !important; }
        body.dark-mode #reset-step-2 .input-group { background: #0f172a !important; }
        body.dark-mode #reset-step-2 input { background: #1e293b !important; border-color: var(--primary) !important; }
        body.dark-mode .sortable-ghost { background: #334155; border-color: var(--primary); }
        body.dark-mode .theme-divider { border-right-color: #475569 !important; }
        body.dark-mode #theme-icon, body.dark-mode #theme-text { color: #cbd5e1 !important; }
        body.dark-mode #theme-dropdown { background: #1e293b !important; border-color: #334155 !important; }
        body.dark-mode .theme-btn:hover { background: #334155; }
        body.dark-mode #theme-dropdown::-webkit-scrollbar-thumb { background: #475569; }
        body.dark-mode #theme-dropdown::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        @media (max-width: 600px) {
            .theme-divider { padding-right: 8px !important; margin-right: 2px !important; }
            .user-header .welcome-msg { display: none; } /* Hide welcome msg on mobile to save space */
            #theme-text { display: none; } /* Hide text on small screens */
        }
    </style>
</head>
<body>

<!-- FULL SCREEN LOADER -->
<div id="loader">
    <div class="spinner"></div>
    <div id="loader-text">Verifying Security...</div>
</div>

<!-- AUTHENTICATION CONTAINER -->
<div id="auth-container">
    
    <!-- Login Form -->
    <div id="login-form" class="auth-card">
        <div style="margin-bottom: 25px;">
            <i class="fa-solid fa-bookmark" style="font-size: 3em; color: var(--primary);"></i>
            <h1 style="font-size: 1.5em; margin: 10px 0 0 0; color: var(--text);">Your Bookmark System</h1>
        </div>
        <h2 style="margin-top: 0; font-size: 1.2em; color: #64748b;">Secure Login</h2>
        <div class="input-group">
            <label>Mobile Number (10 Digits)</label>
            <input type="number" id="login-mobile" oninput="limitMobile(this)" inputmode="numeric">
        </div>
        <div class="input-group">
            <label>PIN (Strictly 6 Digits)</label>
            <input type="password" id="login-pin" oninput="limitPin(this)" inputmode="numeric" maxlength="6">
        </div>
        <button class="btn-full" onclick="doLogin()">Login</button>
        <div class="toggle-link" onclick="toggleAuth('reset')">Forgot PIN?</div>
        <div class="toggle-link" onclick="toggleAuth('signup')">Create New Account</div>
    </div>

    <!-- Signup Form -->
    <div id="signup-form" class="auth-card hidden">
        <div style="margin-bottom: 25px;">
            <i class="fa-solid fa-bookmark" style="font-size: 3em; color: var(--primary);"></i>
            <h1 style="font-size: 1.5em; margin: 10px 0 0 0; color: var(--text);">Your Bookmark System</h1>
        </div>
        <h2 style="margin-top: 0; font-size: 1.2em; color: #64748b;">Sign Up</h2>
        <div class="input-group">
            <label>Full Name</label>
            <input type="text" id="signup-name">
        </div>
        <div class="input-group">
            <label>Mobile Number (10 Digits)</label>
            <input type="number" id="signup-mobile" oninput="limitMobile(this)" inputmode="numeric">
        </div>
        <div class="input-group">
            <label>Email (Required for Reset)</label>
            <input type="email" id="signup-email">
        </div>
        <div class="input-group">
            <label>Set PIN (Strictly 6 Digits)</label>
            <input type="password" id="signup-pin" oninput="limitPin(this)" inputmode="numeric" maxlength="6">
        </div>
        <button class="btn-full" onclick="doSignup()">Create Account</button>
        <div class="toggle-link" onclick="toggleAuth('login')">Back to Login</div>
    </div>

    <!-- Reset PIN Form -->
    <div id="reset-form" class="auth-card hidden">
        <div style="margin-bottom: 25px;">
            <i class="fa-solid fa-bookmark" style="font-size: 3em; color: var(--primary);"></i>
            <h1 style="font-size: 1.5em; margin: 10px 0 0 0; color: var(--text);">Your Bookmark System</h1>
        </div>
        <h2 style="margin-top: 0; font-size: 1.2em; color: #64748b;">Reset PIN</h2>
        
        <div id="reset-step-1">
            <div class="input-group">
                <label>Registered Mobile Number</label>
                <input type="number" id="reset-mobile" oninput="limitMobile(this); autoFetchEmail();" inputmode="numeric">
            </div>
            <div class="input-group">
                <label>Registered Email</label>
                <input type="email" id="reset-email" disabled placeholder="Will auto-fetch from database...">
            </div>
            <button class="btn-full" id="btn-send-otp" onclick="requestOTP()" disabled>Enter Mobile to Fetch Email</button>
        </div>

        <div id="reset-step-2" style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #cbd5e1;">
            <div class="input-group" style="background: #e0f2fe; padding: 10px; border-radius: 8px;">
                <label style="color: #0369a1;">Enter OTP from Email</label>
                <input type="number" id="reset-otp" oninput="limitPin(this)" inputmode="numeric" placeholder="6-Digit OTP" style="border-color: #38bdf8; background: #ffffff;">
            </div>
            <div class="input-group">
                <label>New PIN (Strictly 6 Digits)</label>
                <input type="password" id="reset-new-pin" oninput="limitPin(this)" inputmode="numeric" maxlength="6">
            </div>
            <button class="btn-full" onclick="doResetPin()" style="background: #10b981;">Verify & Update PIN</button>
        </div>
        
        <div class="support-box">
            <i class="fa-solid fa-life-ring"></i> <strong>Need Help?</strong><br>
            <span style="font-size:0.85em; color:#555;">If you haven't linked an email, contact the Admin directly to reset your account.</span>
            <a href="https://wa.me/917017024586?text=Hello Mr. Ambuj Garg, I forgot my App PIN and my email is not linked. Please help me reset it." target="_blank" class="support-btn">
                <i class="fa-brands fa-whatsapp"></i> Chat with Admin
            </a>
            <div style="margin-top:8px; font-weight:bold; font-size:0.85em;">Mr. Ambuj Garg: +91-7017024586</div>
        </div>

        <div class="toggle-link" onclick="toggleAuth('login')">Back to Login</div>
    </div>
</div>

<!-- MAIN APP DASHBOARD -->
<div id="app-container">
    
    <div class="user-header" style="grid-column: 1 / -1;">
        <div class="welcome-msg" id="welcome-text"></div>
        
        <div style="display: flex; gap: 10px; align-items: center;">
            <!-- Theme Selection in Header -->
            <div style="position: relative; display: flex; align-items: center; gap: 8px; border-right: 1px solid #cbd5e1; padding-right: 10px; margin-right: 5px; transition: border-color 0.3s;" class="theme-divider theme-selector-area">
                <button onclick="toggleThemeMenu()" style="background: transparent; border: none; color: #64748b; font-size: 1.2em; cursor: pointer; transition: color 0.3s;" title="Change Theme">
                    <i class="fa-solid fa-palette"></i>
                </button>
                <div id="theme-dropdown" class="hidden" style="position: absolute; top: 35px; right: 0; background: var(--white); border: 1px solid #cbd5e1; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 1000; width: 190px; display: flex; flex-direction: column; padding: 5px; max-height: 50vh; overflow-y: auto;">
                    <!-- Theme options populated by JS -->
                </div>
            </div>

            <!-- Dark Mode Toggle in Header -->
            <div class="theme-divider" style="display: flex; align-items: center; gap: 8px; margin-right: 5px; border-right: 1px solid #cbd5e1; padding-right: 15px; transition: border-color 0.3s;">
                <i class="fa-solid fa-moon" id="theme-icon" style="color: #64748b; font-size: 1.1em; transition: color 0.3s;"></i>
                <span id="theme-text" style="font-size: 0.9em; font-weight: bold; color: #64748b; transition: color 0.3s;">Dark Mode</span>
                <label class="switch" style="margin: 0;">
                  <input type="checkbox" id="pref-dark-mode" onchange="updatePreferences()">
                  <span class="slider"></span>
                </label>
            </div>
            
            <button onclick="toggleSidebar()" style="background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; font-family: inherit;"><i class="fa-solid fa-sliders"></i> Manage</button>
            <button class="logout-btn" onclick="doLogout()"><i class="fa-solid fa-power-off"></i> Logout</button>
        </div>
    </div>

    <!-- Sidebar Controls -->
    <div class="sidebar">
        <!-- Close Icon button -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 id="form-title" style="margin: 0;"><i class="fa-solid fa-plus-circle"></i> New Bookmark</h3>
            <button onclick="toggleSidebar(false)" style="background: transparent; border: none; color: #ef4444; font-size: 1.5em; cursor: pointer; padding: 0;" title="Close Window"><i class="fa-solid fa-circle-xmark"></i></button>
        </div>

        <input type="hidden" id="bm-id">
        <div class="input-group">
            <input type="text" id="bm-title" placeholder="Website Title (e.g., Google)">
        </div>
        <div class="input-group">
            <input type="text" id="bm-url" placeholder="URL (e.g., https://google.com)">
        </div>
        
        <!-- Category & NEW Subcategory Field -->
        <div class="input-group">
            <input type="text" id="bm-category" list="cat-list" placeholder="Category (e.g., Network, HMSI)">
            <datalist id="cat-list"></datalist>
        </div>
        <div class="input-group">
            <input type="text" id="bm-subcategory" list="subcat-list" placeholder="Sub-Category (e.g., Sheets, Forms) - Optional">
            <datalist id="subcat-list"></datalist>
        </div>
        
        <label style="font-size:0.8em; font-weight:bold; margin-top:5px; display:block;">Select Icon:</label>
        <div class="icon-grid" id="icon-selector"></div>
        <input type="hidden" id="bm-icon">
        
        <button class="btn-full" id="save-btn" onclick="saveBookmark()">Add Bookmark</button>
        <button class="btn-full btn-secondary" id="cancel-btn" style="display:none;" onclick="resetForm()">Cancel Editing</button>

        <hr style="margin:20px 0; border:0; border-top:1px solid #ddd;">
        
        <!-- User Settings -->
        <h4><i class="fa-solid fa-palette"></i> Customize View</h4>
        <div class="control-group">
            <label>Card Size</label>
            <select id="pref-size" onchange="updatePreferences()">
                <option value="sm">Small</option>
                <option value="md">Medium</option>
                <option value="lg">Large</option>
                <option value="xl">Extra Large</option>
            </select>
        </div>
        <div class="control-group">
            <label>Layout Style</label>
            <select id="pref-layout" onchange="updatePreferences()">
                <option value="grid">Grid View (Boxes)</option>
                <option value="list">List View (Rows)</option>
            </select>
        </div>
        <div class="control-group">
            <label>List View Columns</label>
            <select id="pref-list-cols" onchange="updatePreferences()">
                <option value="1">1 Item per row</option>
                <option value="2">2 Items per row</option>
                <option value="3">3 Items per row</option>
            </select>
        </div>
        <div class="control-group" style="display: flex; flex-direction: column; gap: 5px;">
            <label>Theme Color</label>
            <input type="color" id="pref-color" onchange="updatePreferences()" style="height:40px; cursor:pointer; width: 100%;">
        </div>
    </div>

    <!-- Bookmarks Display Area -->
    <div class="main-area">
        <div id="bookmarks-target"></div>
    </div>
</div>

<script>
    // ******************************************************
    // ⚠️ PASTE YOUR DEPLOYED GOOGLE SCRIPT URL HERE ⬇️
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxLaE8poowmolrwbb24mFZJmvPQTK7A9pQX9H4zLY2q9PWyqnaqF3UgNdwWz6J9raOAug/exec"; 
    // ******************************************************

    let currentUser = null;
    let bookmarks = [];
    
    // Added new properties to save drag and drop order, darkMode, and theme styling
    let userSettings = { 
        layout: 'grid', 
        sortBy: 'category', 
        theme: '#2563eb', 
        themeName: 'default',
        fontFamily: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
        cardSize: 'md', 
        listCols: '1', 
        categoryOrder: [], 
        subCategoryOrder: {}, 
        darkMode: false 
    };
    
    // Filter States
    let activeFilter = 'All'; // Main Category Filter
    let activeSubFilter = 'All'; // Sub Category Filter
    let isFetchingEmail = false;

    // Stylish, Professional, GenZ, and Robotic Theme Presets
    const themePresets = {
        'default': { name: 'Default Blue', color: '#2563eb', font: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif" },
        'modern': { name: 'Modern Cyan', color: '#0ea5e9', font: "'Trebuchet MS', 'Lucida Sans Unicode', sans-serif" },
        'elegant': { name: 'Elegant Slate', color: '#475569', font: "'Georgia', serif" },
        'sunset': { name: 'Sunset Orange', color: '#f97316', font: "'Arial', sans-serif" },
        'forest': { name: 'Forest Green', color: '#16a34a', font: "'Verdana', sans-serif" },
        'royal': { name: 'Royal Purple', color: '#9333ea', font: "'Palatino Linotype', 'Book Antiqua', Palatino, serif" },
        'rose': { name: 'Rose Red', color: '#e11d48', font: "Tahoma, sans-serif" },
        'cyber': { name: 'Retro Green', color: '#059669', font: "'Courier New', Courier, monospace" },
        
        // --- NEW GenZ & Cybernetic Themes ---
        'matrix': { name: 'Matrix Terminal', color: '#10b981', font: "'Consolas', 'Fira Code', monospace" },
        'neon': { name: 'Neon Cyberpunk', color: '#f43f5e', font: "'Impact', sans-serif" },
        'synthwave': { name: 'Synthwave Indigo', color: '#8b5cf6', font: "'Lucida Console', Monaco, monospace" },
        'dracula': { name: 'Vampire Crimson', color: '#be123c', font: "'Trebuchet MS', sans-serif" },
        'monochrome': { name: 'Stealth Black', color: '#171717', font: "'Arial Black', sans-serif" },
        'oceanic': { name: 'Deep Oceanic', color: '#0f766e', font: "Century Gothic, sans-serif" },
        'genz': { name: 'GenZ Pastel', color: '#a855f7', font: "'Comic Sans MS', cursive, sans-serif" },
        'toxic': { name: 'Toxic Yellow', color: '#eab308', font: "'Courier New', Courier, monospace" },
        'glitch': { name: 'Glitch Violet', color: '#4f46e5', font: "'Franklin Gothic Medium', sans-serif" },
        'hologram': { name: 'Hologram Teal', color: '#14b8a6', font: "'Courier', monospace" }
    };
    
    // Icon Library List
    const commonIcons = [
        "fa-brands fa-google", "fa-brands fa-youtube", "fa-brands fa-whatsapp", "fa-brands fa-instagram", "fa-brands fa-linkedin", "fa-brands fa-github",
        "fa-solid fa-file-excel", "fa-solid fa-table", "fa-solid fa-clipboard-list", "fa-solid fa-square-check", "fa-solid fa-pen-to-square", 
        "fa-solid fa-book-open", "fa-solid fa-calculator", "fa-solid fa-window-maximize", "fa-solid fa-laptop-code", "fa-solid fa-layer-group",
        "fa-solid fa-house", "fa-solid fa-envelope", "fa-solid fa-briefcase", "fa-solid fa-code", "fa-solid fa-globe", "fa-solid fa-cart-shopping",
        "fa-solid fa-music", "fa-solid fa-video", "fa-solid fa-image", "fa-solid fa-book", "fa-solid fa-calendar", "fa-solid fa-chart-line"
    ];

    window.onload = function() { 
        populateIcons(); 
        populateThemes();
        initApp(); 
    };

    // Global click listener to close theme dropdown when clicking outside
    window.addEventListener('click', function(e) {
        if (!e.target.closest('.theme-selector-area')) {
            const dropdown = document.getElementById('theme-dropdown');
            if (dropdown && !dropdown.classList.contains('hidden')) {
                dropdown.classList.add('hidden');
            }
        }
    });

    // --- THEME MANAGEMENT ---
    function populateThemes() {
        const dropdown = document.getElementById('theme-dropdown');
        dropdown.innerHTML = '';
        Object.keys(themePresets).forEach(key => {
            const t = themePresets[key];
            const btn = document.createElement('button');
            btn.className = 'theme-btn';
            btn.style.fontFamily = t.font;
            btn.innerHTML = `<span style="display:inline-block; width:12px; height:12px; border-radius:50%; background:${t.color}; margin-right:8px; border: 1px solid rgba(0,0,0,0.1);"></span> ${t.name}`;
            btn.onclick = () => selectTheme(key);
            dropdown.appendChild(btn);
        });
    }

    function toggleThemeMenu() {
        document.getElementById('theme-dropdown').classList.toggle('hidden');
    }

    function selectTheme(key) {
        if(themePresets[key]) {
            userSettings.themeName = key;
            userSettings.theme = themePresets[key].color;
            userSettings.fontFamily = themePresets[key].font;
            document.getElementById('pref-color').value = userSettings.theme;
            updatePreferences();
        }
        document.getElementById('theme-dropdown').classList.add('hidden');
    }

    // --- UTILITIES AND SANITIZATION ---
    function limitMobile(el) {
        el.value = el.value.replace(/[^0-9]/g, '');
        if (el.value.length > 10) el.value = el.value.slice(0, 10);
    }
    
    function limitPin(el) {
        el.value = el.value.replace(/[^0-9]/g, '');
        if (el.value.length > 6) el.value = el.value.slice(0, 6);
    }
    
    function isValidPin(pin) {
        return /^\d{6}$/.test(pin);
    }

    function toggleLoader(show, text) { 
        const loaderObj = document.getElementById('loader');
        loaderObj.style.display = show ? 'flex' : 'none'; 
        if(text) document.getElementById('loader-text').innerText = text; 
    }

    function toggleAuth(screen) { 
        document.querySelectorAll('.auth-card').forEach(c => c.classList.add('hidden'));
        if(screen === 'login') document.getElementById('login-form').classList.remove('hidden');
        if(screen === 'signup') document.getElementById('signup-form').classList.remove('hidden');
        if(screen === 'reset') {
            document.getElementById('reset-form').classList.remove('hidden');
            document.getElementById('reset-mobile').value = '';
            document.getElementById('reset-email').value = '';
            document.getElementById('reset-otp').value = '';
            document.getElementById('reset-new-pin').value = '';
            autoFetchEmail();
        }
    }

    function autoFetchEmail() {
        const mobile = document.getElementById('reset-mobile').value;
        const emailInput = document.getElementById('reset-email');
        const sendBtn = document.getElementById('btn-send-otp');
        
        if (mobile.length === 10 && !isFetchingEmail) {
            isFetchingEmail = true;
            emailInput.value = "";
            emailInput.placeholder = "Checking database...";
            sendBtn.innerText = "Loading...";
            sendBtn.disabled = true;
            
            fetch(SCRIPT_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: "get_email", mobile: mobile }) 
            })
            .then(r => r.json())
            .then(d => { 
                isFetchingEmail = false;
                if(d.result === "success") {
                    emailInput.value = d.email;
                    sendBtn.disabled = false;
                    sendBtn.innerText = "Send OTP to Email";
                } else {
                    emailInput.placeholder = d.message;
                    sendBtn.disabled = true;
                    sendBtn.innerText = "Mobile Number Not Found";
                }
            }).catch(() => {
                isFetchingEmail = false;
                emailInput.placeholder = "Error connecting to database.";
            });
        } else if (mobile.length < 10) {
            emailInput.value = "";
            emailInput.placeholder = "Will auto-fetch from database...";
            sendBtn.disabled = true;
            sendBtn.innerText = "Enter Mobile to Fetch Email";
        }
    }

    // --- APP INITIALIZATION AND SECURITY ---
    function initApp() {
        const session = localStorage.getItem('user_session_final');
        if (session) {
            toggleLoader(true, "Verifying Security...");
            currentUser = JSON.parse(session);
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "login", mobile: currentUser.mobile, pin: currentUser.pin })
            })
            .then(res => res.json())
            .then(data => {
                if (data.result === "success") {
                    loadUserData(data.bookmarks);
                    openDashboard();
                } else {
                    alert("Session Expired or PIN Changed for security!");
                    doLogout();
                }
            }).catch(() => {
                alert("Connection Error. Please check your internet.");
                toggleLoader(false); 
                document.getElementById('auth-container').style.display = 'flex';
            });
        } else {
            toggleLoader(false);
            document.getElementById('auth-container').style.display = 'flex';
        }
    }

    function loadUserData(jsonString) {
        let parsed = JSON.parse(jsonString || "[]");
        
        if (parsed.items) {
            bookmarks = parsed.items;
            if(parsed.settings) {
                userSettings = { ...userSettings, ...parsed.settings }; 
            }
        } else if(Array.isArray(parsed)) {
            bookmarks = parsed; 
        }

        // Apply defaults if missing
        if(!userSettings.fontFamily) userSettings.fontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
        
        document.getElementById('pref-layout').value = userSettings.layout;
        document.getElementById('pref-color').value = userSettings.theme;
        document.getElementById('pref-size').value = userSettings.cardSize;
        document.getElementById('pref-list-cols').value = userSettings.listCols || '1';
        
        // Setup Dark Mode toggle based on settings
        const isDarkMode = userSettings.darkMode || false;
        document.getElementById('pref-dark-mode').checked = isDarkMode;
        if(isDarkMode) {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }
        
        document.documentElement.style.setProperty('--primary', userSettings.theme);
        document.documentElement.style.setProperty('--font-family', userSettings.fontFamily);
        applySize(userSettings.cardSize);
        applyListColumns(userSettings.listCols || '1');
    }

    function applySize(size) {
        const root = document.documentElement;
        if(size === 'sm') { root.style.setProperty('--card-size', '100px'); root.style.setProperty('--icon-size', '1.8em'); root.style.setProperty('--title-size', '0.8em'); }
        else if(size === 'md') { root.style.setProperty('--card-size', '140px'); root.style.setProperty('--icon-size', '2.5em'); root.style.setProperty('--title-size', '0.9em'); }
        else if(size === 'lg') { root.style.setProperty('--card-size', '180px'); root.style.setProperty('--icon-size', '3.5em'); root.style.setProperty('--title-size', '1em'); }
        else if(size === 'xl') { root.style.setProperty('--card-size', '220px'); root.style.setProperty('--icon-size', '4.5em'); root.style.setProperty('--title-size', '1.1em'); }
    }

    function applyListColumns(cols) {
        document.documentElement.style.setProperty('--list-cols', cols);
    }

    function syncToCloud() {
        if(!currentUser) return;
        const payload = { settings: userSettings, items: bookmarks };
        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: "sync", mobile: currentUser.mobile, pin: currentUser.pin, bookmarks: JSON.stringify(payload) })
        });
    }

    // --- BOOKMARK OPERATIONS ---
    function saveBookmark() {
        const id = document.getElementById('bm-id').value;
        const title = document.getElementById('bm-title').value.trim();
        const url = document.getElementById('bm-url').value.trim();
        const category = document.getElementById('bm-category').value.trim() || 'General';
        const subcategory = document.getElementById('bm-subcategory').value.trim() || ''; 
        const icon = document.getElementById('bm-icon').value || 'fa-solid fa-link';

        if(!title || !url) return alert("Title and URL are required fields.");

        let finalUrl = url;
        if (!/^https?:\/\//i.test(finalUrl)) {
            finalUrl = 'https://' + finalUrl;
        }

        if (id) {
            const idx = bookmarks.findIndex(b => b.id == id);
            if(idx !== -1) {
                let oldOrder = bookmarks[idx].order;
                bookmarks[idx] = { id: parseInt(id), title, url: finalUrl, category, subcategory, icon, order: oldOrder };
            }
        } else {
            bookmarks.push({ id: Date.now(), title, url: finalUrl, category, subcategory, icon });
        }
        
        resetForm();
        renderBookmarks();
        syncToCloud();
        toggleSidebar(false); 
    }

    function editBookmark(id) {
        toggleSidebar(true); 
        const bm = bookmarks.find(b => b.id === id);
        if(!bm) return;
        
        document.getElementById('bm-id').value = bm.id;
        document.getElementById('bm-title').value = bm.title;
        document.getElementById('bm-url').value = bm.url;
        document.getElementById('bm-category').value = bm.category;
        document.getElementById('bm-subcategory').value = bm.subcategory || ''; 
        document.getElementById('bm-icon').value = bm.icon;
        
        document.getElementById('save-btn').innerText = 'Update Bookmark';
        document.getElementById('form-title').innerHTML = '<i class="fa-solid fa-pen"></i> Edit Bookmark';
        document.getElementById('cancel-btn').style.display = 'block';
        
        document.querySelectorAll('.icon-option').forEach(el => el.classList.remove('selected'));
    }

    function resetForm() {
        document.getElementById('bm-id').value = '';
        document.getElementById('bm-title').value = '';
        document.getElementById('bm-url').value = '';
        document.getElementById('bm-category').value = '';
        document.getElementById('bm-subcategory').value = ''; 
        document.getElementById('save-btn').innerText = 'Add Bookmark';
        document.getElementById('form-title').innerHTML = '<i class="fa-solid fa-plus-circle"></i> New Bookmark';
        document.getElementById('cancel-btn').style.display = 'none';
    }

    function deleteBookmark(id) {
        if(confirm("Are you sure you want to delete this bookmark?")) {
            bookmarks = bookmarks.filter(b => b.id !== id);
            if(document.getElementById('bm-id').value == id) resetForm();
            renderBookmarks();
            syncToCloud();
        }
    }

    function updatePreferences() {
        userSettings.layout = document.getElementById('pref-layout').value;
        userSettings.theme = document.getElementById('pref-color').value;
        userSettings.cardSize = document.getElementById('pref-size').value;
        userSettings.listCols = document.getElementById('pref-list-cols').value;
        
        // Handle Dark Mode State
        userSettings.darkMode = document.getElementById('pref-dark-mode').checked;
        if(userSettings.darkMode) {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }
        
        document.documentElement.style.setProperty('--primary', userSettings.theme);
        // Note: fontFamily is managed entirely by selectTheme, custom color keeps active font.
        document.documentElement.style.setProperty('--font-family', userSettings.fontFamily || "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif");
        
        applySize(userSettings.cardSize);
        applyListColumns(userSettings.listCols);
        
        renderBookmarks();
        syncToCloud();
    }

    function setCategoryFilter(cat) {
        activeFilter = cat;
        activeSubFilter = 'All'; // Reset sub-filter when main category changes
        renderBookmarks();
    }
    
    function setSubCategoryFilter(subCat) {
        activeSubFilter = subCat;
        renderBookmarks();
    }

    // --- RENDERING ENGINE (UPDATED FOR DRAG & DROP) ---
    function renderBookmarks() {
        const container = document.getElementById('bookmarks-target');
        container.innerHTML = '';
        
        // 1. Populate Datalists for Dropdowns
        let rawCats = [...new Set(bookmarks.map(b => b.category))];
        
        // Apply custom order to categories
        if (userSettings.categoryOrder && userSettings.categoryOrder.length > 0) {
            rawCats.sort((a, b) => {
                let idxA = userSettings.categoryOrder.indexOf(a);
                let idxB = userSettings.categoryOrder.indexOf(b);
                if (idxA === -1) idxA = 999;
                if (idxB === -1) idxB = 999;
                return idxA - idxB;
            });
        } else {
            rawCats.sort();
        }
        const cats = rawCats;

        document.getElementById('cat-list').innerHTML = cats.map(c => `<option value="${c}">`).join('');
        const globalSubCats = [...new Set(bookmarks.map(b => b.subcategory).filter(Boolean))].sort();
        document.getElementById('subcat-list').innerHTML = globalSubCats.map(c => `<option value="${c}">`).join('');

        if(bookmarks.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding: 50px 0; color:#888;"><i class="fa-solid fa-folder-open fa-3x" style="margin-bottom:15px; opacity:0.5;"></i><br>No bookmarks found. Add your first one!</div>';
            return;
        }

        if(activeFilter !== 'All' && !cats.includes(activeFilter)) {
            activeFilter = 'All';
        }

        // 2. Render Main Category Filter
        const filterDiv = document.createElement('div');
        filterDiv.className = 'category-filter';
        
        // 'All' button has static-btn class to prevent dragging
        let allBtn = `<button class="filter-btn static-btn ${activeFilter === 'All' ? 'active' : ''}" onclick="setCategoryFilter('All')">All</button>`;
        let catBtns = cats.map(c => `<button class="filter-btn ${activeFilter === c ? 'active' : ''}" onclick="setCategoryFilter('${c}')">${c}</button>`).join('');
        filterDiv.innerHTML = allBtn + catBtns;
        container.appendChild(filterDiv);

        // Category Drag and Drop (Sortable)
        Sortable.create(filterDiv, {
            animation: 150,
            filter: '.static-btn', // Prevent 'All' button from being dragged
            delay: 200, delayOnTouchOnly: true, // Delay to fix mobile touch scroll issue
            onEnd: function () {
                const btns = Array.from(filterDiv.querySelectorAll('.filter-btn:not(.static-btn)'));
                userSettings.categoryOrder = btns.map(b => b.innerText);
                syncToCloud();
            }
        });

        let displayItems = bookmarks;
        let hasSubcats = false;

        // 3. Render Sub-Category Filter (If in a specific category)
        if (activeFilter !== 'All') {
            displayItems = bookmarks.filter(b => b.category === activeFilter);
            
            let subCatsInCurrentCat = [...new Set(displayItems.map(b => b.subcategory).filter(Boolean))];
            
            // Apply sub-category order
            let subOrder = (userSettings.subCategoryOrder && userSettings.subCategoryOrder[activeFilter]) || [];
            if (subOrder.length > 0) {
                subCatsInCurrentCat.sort((a, b) => {
                    let idxA = subOrder.indexOf(a);
                    let idxB = subOrder.indexOf(b);
                    if (idxA === -1) idxA = 999;
                    if (idxB === -1) idxB = 999;
                    return idxA - idxB;
                });
            } else {
                subCatsInCurrentCat.sort();
            }

            hasSubcats = subCatsInCurrentCat.length > 0;
            
            if (hasSubcats) {
                const subFilterDiv = document.createElement('div');
                subFilterDiv.className = 'subcategory-filter';
                
                let allSubBtn = `<button class="sub-filter-btn static-btn ${activeSubFilter === 'All' ? 'active' : ''}" onclick="setSubCategoryFilter('All')">All</button>`;
                let subCatBtns = subCatsInCurrentCat.map(c => `<button class="sub-filter-btn ${activeSubFilter === c ? 'active' : ''}" onclick="setSubCategoryFilter('${c}')">${c}</button>`).join('');
                
                subFilterDiv.innerHTML = allSubBtn + subCatBtns;
                container.appendChild(subFilterDiv);

                // Subcategory Drag and Drop (Sortable)
                Sortable.create(subFilterDiv, {
                    animation: 150,
                    filter: '.static-btn',
                    delay: 200, delayOnTouchOnly: true,
                    onEnd: function () {
                        const btns = Array.from(subFilterDiv.querySelectorAll('.sub-filter-btn:not(.static-btn)'));
                        if(!userSettings.subCategoryOrder) userSettings.subCategoryOrder = {};
                        userSettings.subCategoryOrder[activeFilter] = btns.map(b => b.innerText);
                        syncToCloud();
                    }
                });
            } else {
                activeSubFilter = 'All'; // Force reset if no subcategories
            }

            // Apply Sub-Category Filter
            if (activeSubFilter !== 'All') {
                displayItems = displayItems.filter(b => b.subcategory === activeSubFilter);
            }
        } else {
            activeSubFilter = 'All'; // Always 'All' when viewing all categories
        }

        // Sort bookmarks by their custom order
        displayItems.sort((a, b) => (a.order || 0) - (b.order || 0));

        // 4. Grouping Logic
        let groups = {};
        displayItems.forEach(b => { 
            let groupKey = 'Default';
            if (activeFilter === 'All') {
                // When viewing everything, group by Main Category
                groupKey = b.category || 'Default'; 
            } else {
                if (hasSubcats) {
                    // If subcategory exists, put blanks in 'Default'
                    groupKey = b.subcategory ? b.subcategory : 'Default'; 
                } else {
                    // If no subcategory, use legacy style
                    groupKey = activeFilter; 
                }
            }

            if(!groups[groupKey]) groups[groupKey] = []; 
            groups[groupKey].push(b); 
        });

        // 5. Render Groups and Cards
        // Always keep 'Default' at the end of the list
        let sortedKeys = Object.keys(groups).sort((a, b) => {
            if (a === 'Default') return 1;
            if (b === 'Default') return -1;
            
            // If view is not 'All', group names are subcategories, sort them by subOrder
            if (activeFilter !== 'All' && hasSubcats) {
                let subOrder = (userSettings.subCategoryOrder && userSettings.subCategoryOrder[activeFilter]) || [];
                let idxA = subOrder.indexOf(a);
                let idxB = subOrder.indexOf(b);
                if (idxA === -1) idxA = 999;
                if (idxB === -1) idxB = 999;
                if(idxA !== idxB) return idxA - idxB;
            }
            return a.localeCompare(b);
        });

        sortedKeys.forEach(groupName => {
            // Header
            const header = document.createElement('div');
            header.className = 'section-title'; 
            header.innerText = groupName;
            container.appendChild(header);

            // Container
            const wrapper = document.createElement('div');
            wrapper.className = `bookmarks-container ${userSettings.layout === 'list' ? 'view-list' : 'view-grid'}`;
            
            groups[groupName].forEach(b => {
                const card = document.createElement('div');
                card.className = 'b-card cursor-grab';
                card.setAttribute('data-id', b.id); // Needed for reordering
                card.onclick = (e) => { 
                    if(!e.target.closest('.action-btn')) window.open(b.url, '_blank'); 
                };
                
                const actionButtonsHTML = `
                    <div class="action-btns">
                        <button class="action-btn btn-edit" title="Edit" onclick="editBookmark(${b.id})"><i class="fa-solid fa-pen"></i></button>
                        <button class="action-btn btn-del" title="Delete" onclick="deleteBookmark(${b.id})"><i class="fa-solid fa-trash"></i></button>
                    </div>`;

                if (userSettings.layout === 'list') {
                    card.innerHTML = `
                        <div class="card-content">
                            <i class="${b.icon} b-icon"></i>
                            <span class="b-title">${b.title}</span>
                        </div>
                        ${actionButtonsHTML}
                    `;
                } else {
                    card.innerHTML = `
                        ${actionButtonsHTML}
                        <i class="${b.icon} b-icon"></i>
                        <div class="b-title">${b.title}</div>
                    `;
                }
                wrapper.appendChild(card);
            });
            container.appendChild(wrapper);

            // Cards Drag and Drop (Sortable)
            Sortable.create(wrapper, {
                animation: 150,
                ghostClass: 'sortable-ghost', // Visual style of card while dragging
                delay: 200, delayOnTouchOnly: true, // Mobile touch scroll fix
                onEnd: function () {
                    const cards = Array.from(wrapper.querySelectorAll('.b-card'));
                    cards.forEach((card, index) => {
                        const id = card.getAttribute('data-id');
                        const bm = bookmarks.find(b => b.id == parseInt(id));
                        if (bm) bm.order = index; // Save new order
                    });
                    syncToCloud();
                }
            });
        });
    }

    // --- AUTHENTICATION API CALLS ---
    function doLogin() {
        const mobile = document.getElementById('login-mobile').value;
        const pin = document.getElementById('login-pin').value;
        
        if(!mobile || !pin) return alert("Please fill in all fields.");
        if(mobile.length !== 10) return alert("Mobile number must be exactly 10 digits.");
        if(!isValidPin(pin)) return alert("PIN must be exactly 6 numeric digits.");
        
        toggleLoader(true, "Logging in securely...");
        
        fetch(SCRIPT_URL, { 
            method: 'POST', 
            body: JSON.stringify({ action: "login", mobile: mobile, pin: pin }) 
        })
        .then(r => r.json())
        .then(d => {
            if(d.result === "success") {
                currentUser = { mobile: mobile, pin: pin, name: d.name };
                localStorage.setItem('user_session_final', JSON.stringify(currentUser));
                loadUserData(d.bookmarks);
                openDashboard();
            } else { 
                alert(d.message); 
                toggleLoader(false); 
            }
        })
        .catch(err => { alert("Connection Failed. Please try again."); toggleLoader(false); });
    }
    
    function doSignup() {
        const name = document.getElementById('signup-name').value.trim();
        const mobile = document.getElementById('signup-mobile').value;
        const email = document.getElementById('signup-email').value.trim();
        const pin = document.getElementById('signup-pin').value;
        
        if(!name || !mobile || !pin || !email) return alert("Please fill all details including email.");
        if(mobile.length !== 10) return alert("Mobile number must be exactly 10 digits.");
        if(!isValidPin(pin)) return alert("PIN must be exactly 6 numeric digits.");

        toggleLoader(true, "Creating Account...");
        
        fetch(SCRIPT_URL, { 
            method: 'POST', 
            body: JSON.stringify({ action: "signup", name: name, mobile: mobile, email: email, pin: pin }) 
        })
        .then(r => r.json())
        .then(d => { 
            alert(d.message); 
            toggleLoader(false); 
            if(d.result === "success") toggleAuth('login'); 
        });
    }

    function requestOTP() {
        const mobile = document.getElementById('reset-mobile').value;
        const email = document.getElementById('reset-email').value.trim();

        if(!mobile || !email) return alert("Mobile and Email are required to send OTP.");
        if(mobile.length !== 10) return alert("Mobile number must be exactly 10 digits.");

        toggleLoader(true, "Sending OTP to your Email...");

        fetch(SCRIPT_URL, { 
            method: 'POST', 
            body: JSON.stringify({ action: "send_otp", mobile: mobile, email: email }) 
        })
        .then(r => r.json())
        .then(d => { 
            toggleLoader(false); 
            if(d.result === "success") {
                alert(d.message);
                document.getElementById('btn-send-otp').innerText = "Resend OTP";
            } else {
                alert(d.message);
            }
        });
    }
    
    function doResetPin() {
        const mobile = document.getElementById('reset-mobile').value;
        const email = document.getElementById('reset-email').value.trim();
        const otp = document.getElementById('reset-otp').value;
        const newPin = document.getElementById('reset-new-pin').value;
        
        if(!otp || !newPin) return alert("Please enter the OTP and a new PIN.");
        if(!isValidPin(otp)) return alert("OTP must be exactly 6 numeric digits.");
        if(!isValidPin(newPin)) return alert("New PIN must be exactly 6 numeric digits.");
        
        toggleLoader(true, "Verifying OTP and Resetting PIN...");
        
        fetch(SCRIPT_URL, { 
            method: 'POST', 
            body: JSON.stringify({ action: "reset_pin", mobile: mobile, email: email, otp: otp, new_pin: newPin }) 
        })
        .then(r => r.json())
        .then(d => { 
            alert(d.message); 
            toggleLoader(false); 
            if(d.result === "success") toggleAuth('login'); 
        });
    }
    
    function doLogout() {
        localStorage.removeItem('user_session_final');
        currentUser = null; 
        bookmarks = [];
        
        document.getElementById('app-container').style.display = 'none';
        document.getElementById('auth-container').style.display = 'flex';
        document.getElementById('login-pin').value = '';
        toggleLoader(false);
    }
    
    function openDashboard() {
        toggleLoader(false);
        document.getElementById('auth-container').style.display = 'none';
        const appContainer = document.getElementById('app-container');
        appContainer.style.display = 'grid';
        appContainer.classList.remove('with-sidebar'); 
        document.getElementById('welcome-text').innerText = `Welcome back, ${currentUser.name || 'User'}!`;
        renderBookmarks();
    }

    function toggleSidebar(forceOpen = null) {
        const container = document.getElementById('app-container');
        let willOpen = false;
        
        if (forceOpen === true) {
            willOpen = true;
            container.classList.add('with-sidebar');
        } else if (forceOpen === false) {
            willOpen = false;
            container.classList.remove('with-sidebar');
        } else {
            willOpen = !container.classList.contains('with-sidebar');
            container.classList.toggle('with-sidebar');
        }

        // If sidebar is closing (via Manage button or X), reset the form
        if (!willOpen) {
            resetForm();
        }
    }
    
    // Auto-populate icons on load
    function populateIcons() {
        const grid = document.getElementById('icon-selector');
        grid.innerHTML = ''; 
        commonIcons.forEach(iconClass => {
            const div = document.createElement('div'); 
            div.className = 'icon-option'; 
            div.innerHTML = `<i class="${iconClass} fa-lg"></i>`;
            
            div.onclick = () => { 
                document.getElementById('bm-icon').value = iconClass; 
                document.querySelectorAll('.icon-option').forEach(e => e.classList.remove('selected')); 
                div.classList.add('selected'); 
            };
            grid.appendChild(div);
        });
    }
</script>
</body>
</html>
